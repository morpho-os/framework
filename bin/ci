#!/usr/bin/env bash

set -euo pipefail

# id: uid=1001(runner) gid=116(docker) groups=116(docker),4(adm),101(systemd-journal)
# perms: 755 for dirs, 644 for files, user: runner, group: docker

prepareEnv() {
    sudo id
    sudo npm install -g typescript@next

    # Create block device
    sudo mknod -m 0777 /tmp/block-dev-test b 125 1
    sudo chown $(id -u):$(id -g) /tmp/block-dev-test

    # To running Selenium && firefox, see https://docs.travis-ci.com/user/gui-and-headless-browsers/
    export DISPLAY=:99
    # `start-stop-daemon` is provided by the `dpkg` package
    /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1280x1024x16

    pushd client > /dev/null
    npm install
    popd > /dev/null

    #  - composer config -g github-oauth.github.com ${COMPOSER_TOKEN} &> /dev/null
    composer install --no-interaction

    mysql -uroot -e "DROP DATABASE IF EXISTS test; CREATE DATABASE test DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci";
    mysql -uroot -e "SHOW DATABASES"
}

runTests() {
    bin/test
    php test/lint.php
}

deployResults() {
    :
    ## https://docs.travis-ci.com/user/deployment/pages/
    ## deploy nightly builds
    ##deploy:
    ##  provider: pages
    ##  skip-cleanup: true
    ##  github-token: $GITHUB_TOKEN
    ##  keep-history: true
    ##  # Directory to push to GitHub Pages, relative to the current directory, defaults to the current directory (example: your_build_folder)
    ##  local-dir: test/result
    ##  # Optional, be verbose about internal steps, defaults to false.
    ##  verbose: false
    ##  on:
    ##    repo: morpho-os/morpho-os.github.io
    ##    branch: master
}

prepareEnv
runTests
deployResults