#!/usr/bin/env php
<?php declare(strict_types=1);

/**
 * This file is part of morpho-os/framework
 * It is distributed under the 'Apache License Version 2.0' license.
 * See the https://github.com/morpho-os/framework/blob/master/LICENSE for the full license text.
 */

use const Morpho\App\BACKEND_DIR_NAME;
use const Morpho\App\TEST_DIR_NAME;

require __DIR__ . '/../vendor/autoload.php';

$moduleTests = '';
$indent = '            ';
$baseDirPath = realpath(__DIR__ . '/..');
foreach (glob($baseDirPath . '/' . BACKEND_DIR_NAME . '/*') as $moduleDirPath) {
    if (!is_dir($moduleDirPath)) {
        continue;
    }
    $moduleName = basename($moduleDirPath);
    $testDirPath = $moduleDirPath . '/' . TEST_DIR_NAME;
    if (is_dir($testDirPath)) {
        $moduleTests .= $indent . '<directory>../backend/' . $moduleName . '/test</directory>';
    }
}
$curFilePath = 'bin/' . basename(__FILE__);
$phpunitXml = <<<OUT
<?xml version="1.0"?>
<!-- Generated by the $curFilePath, don't edit as it will be overwritten on the next run -->
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/10.0/phpunit.xsd"
         bootstrap="./bootstrap.php"
         colors="true"
         verbose="true"
         stopOnDefect="true"
         stopOnError="true"
         stopOnFailure="true"
         stopOnWarning="true"
         stopOnIncomplete="true"
         stopOnRisky="true"
         stopOnSkipped="false"
         failOnEmptyTestSuite="true"
         failOnIncomplete="true"
         failOnRisky="true"
         failOnSkipped="true"
         failOnWarning="true"
         forceCoversAnnotation="false"
         beStrictAboutChangesToGlobalState="true"
         beStrictAboutOutputDuringTests="true"
         beStrictAboutTestsThatDoNotTestAnything="true"
         beStrictAboutCoversAnnotation="true"
         cacheDirectory=".phpunit.cache">
    <testsuites>
        <testsuite name="lib">
            <!--<file>TestSuite.php</file>-->
            <directory>.</directory>
            <exclude>Unit/App/MessageTest.php</exclude>
            <exclude>Unit/Caching/CacheTest.php</exclude>
            <exclude>Unit/Tech/MySql/QueryTest.php</exclude>
            <exclude>Unit/Tech/Php/BaseErrorHandlerTest.php</exclude>
            <exclude>Unit/Tech/Php/DiscoverStrategyTest.php</exclude>
            <exclude>Unit/Tech/Php/test-data/ClassTypeDiscovererTest/Test.php</exclude>
        </testsuite>
        <testsuite name="module">
$moduleTests
        </testsuite>
    </testsuites>
    <coverage>
        <include>
            <directory suffix=".php">lib</directory>
        </include>
    </coverage>
</phpunit>
OUT;
$phpunitConfFilePath = $baseDirPath . '/' . TEST_DIR_NAME . '/phpunit.xml';
file_put_contents($phpunitConfFilePath, $phpunitXml);
echo "Written: " . $phpunitConfFilePath . "\n";